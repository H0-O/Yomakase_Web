<div th:fragment="calendar" xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
     xmlns:th="http://www.thymeleaf.org">
  <section class="ftco-section">
    <div class="container">
      <div class="row justify-content-center"></div>
      <div class="cal-title">
        <h3 id="dietCalTitle" style="display: block; font-weight: bold">식단 달력</h3>
        <h3 id="nutrientCalTitle" style="display: none; font-weight: bold">영양소 달력</h3>
      </div>
      <div id="cal-title-btn" style="visibility: hidden">
        <button id="dietCalBtn">식단</button><button id="nutrientCalBtn">영양소</button>
      </div>
      <!-- 여기서부터 달력 부분-->
      <div class="row">
        <div class="col-md-12">
          <div class="elegant-calencar d-md-flex">
            <div class="wrap-header d-flex align-items-center img" style="background-image: url(/img/cal_food_0.png);">
              <p id="reset">Today</p>
              <div id="header" class="p-0">
                <div class="head-info">
                  <div class="head-month"></div>
                  <div class="head-day"></div> <br>
                  <br>
                  <div id="diet-list" style="display: none">
                    <table>
                      <tr>
                        <td>아침</td>
                        <td></td>
                      </tr>
                      <tr>
                        <td>점심</td>
                        <td></td>
                      </tr>
                      <tr>
                        <td>저녁</td>
                        <td></td>
                      </tr>
                    </table>
                  </div>
                  <div id="nutrient-list" style="display: none">
                    <table>
                      <tr>
                        <th>총 칼로리</th>
                        <td></td>
                      </tr>
                      <tr>
                        <th>과하게 섭취</th>
                        <td></td>
                      </tr>
                      <tr>
                        <th>부족한 섭취</th>
                        <td></td>
                      </tr>
                      <tr>
                        <th>식단 점수</th>
                        <td></td>
                      </tr>
                    </table>
                  </div>
                  <div id="diet-list-msg" style="display: block;">
                    <table>
                      <tr>
                        <td>해당 날짜에 입력된</td>
                      </tr>
                      <tr>
                        <td>식단이 없습니다.</td>
                      </tr>
                      <tr>
                        <td>식단을 입력하고 싶다면</td>
                      </tr>
                      <tr>
                        <td>날짜를 더블클릭 해주세요.</td>
                      </tr>
                    </table>
                  </div>
                </div>
              </div>
            </div>

            <div class="calendar-wrap">
              <div class="w-100 button-wrap">
                <div class="pre-button d-flex align-items-center justify-content-center"><i class="fa fa-chevron-left"></i></div>
                <div id="head-date" style="font-weight: bold;"></div> <!-- 2024년 9월 -->
                <div class="head-month"></div>
                <div class="next-button d-flex align-items-center justify-content-center"><i class="fa fa-chevron-right"></i></div>
              </div>
              <table id="calendarTable">
                <thead>
                <tr>
                  <th>Sun</th>
                  <th>Mon</th>
                  <th>Tue</th>
                  <th>Wed</th>
                  <th>Thu</th>
                  <th>Fri</th>
                  <th>Sat</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                </tr>
                <tr>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                </tr>
                <tr>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                </tr>
                <tr>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                </tr>
                <tr>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                </tr>
                <tr>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <table id="recomTable" style="visibility: hidden">
    <tr>
      <td style="text-align: center;">
        <p>입력된 식단을 바탕으로 권장 식단을 추천해드립니다.</p>
        <p>영양소 달력에서 날짜를 클릭해 주세요.</p>
      </td>
    </tr>

  </table>

  <!--식단 입력 모달 부분-->
  <div id="diet-modal" class="cal-modal-overlay">
    <div class="cal-modal-window">
      <div class="cal-modal-title">
        <h4>식단 입력</h4>
      </div>
      <div class="close-btn"><img src="/img/closeIcon.png"></div>
      <div class="cal-content">
        <table id="diet-modal-table">
          <tr>
            <th colspan="2" class="clickedDietDay">클릭한 날짜</th>
            <td></td>
          </tr>
          <tr>
            <th>아침</th>
            <td><input type="text" id="bName" placeholder="아침 식사 메뉴를 알려주세요"></td>
          </tr>
          <tr>
            <th>점심</th>
            <td><input type="text" id="lName" placeholder="점심 식사 메뉴를 알려주세요"></td>
          </tr>
          <tr>
            <th>저녁</th>
            <td><input type="text" id="dName" placeholder="저녁 식사 메뉴를 알려주세요"></td>
          </tr>
          <tr>
            <td colspan="2"><button id="dietBtn">식단 저장</button></td>
            <td></td>
          </tr>
        </table>
      </div>
    </div>
  </div>
  <div id="diet-loading-modal">
    <div class="loading-modal-content">
      <p>식단 입력 중...</p>
      <div class="spinner"></div>
    </div>
  </div>


  <script src="/js/calendar.js"></script>
  <script src="/js/diet-cal-modal_js.js"></script>


  <!--식단 저장 기능-->
  <script th:inline="javascript">
    let memberData = {
      birthDate: [[${member.birthDate}]],  // 날짜 데이터
      gender: [[${member.gender}]],  // 문자열 데이터
      height: [[${member.height}]],  // 숫자 데이터
      weight: [[${member.weight}]]  // 숫자 데이터
    };


    document.addEventListener('DOMContentLoaded', function() {
      let dietBtn = document.getElementById('dietBtn');
      dietBtn.addEventListener('click', dietInput);
    });

    function dietInput(){
      let bName = document.getElementById('bName').value;
      let lName = document.getElementById('lName').value;
      let dName = document.getElementById('dName').value;
      let clickedDietDay = document.getElementsByClassName('clickedDietDay')[0].textContent;

      if(bName.length === 0 && lName.length === 0 && dName.length === 0) {
        alert("식단을 입력해 주세요.");
        document.getElementById('bName').focus();
        return;
      }
      let age = calculateAge(memberData.birthDate);
      let dietData = {
        breakfast: bName,
        lunch: lName,
        dinner: dName,
        age: age,
        gender: memberData.gender,
        height: memberData.height,
        weight: memberData.weight,
        date: clickedDietDay
      };
      document.getElementById('diet-loading-modal').style.display = 'flex';
      $.ajax({
        url: 'http://localhost:8000/nutrition',  // FastAPI 엔드포인트
        type: 'POST',
        contentType: 'application/json',  // JSON 형식으로 데이터 전송
        data: JSON.stringify(dietData),  // FastAPI로 보낼 데이터를 JSON 형식으로 직렬화
        success: function(responseData) {
          // 'rec' 필드에서 대괄호를 제거하여 단순 문자열로 처리
          if (responseData.rec) {
            responseData.rec = responseData.rec.replace(/\[/g, "\\[").replace(/\]/g, "\\]");  // 대괄호를 이스케이프 처리
          }

          // 'kal' 객체가 존재하는지 확인
          if (responseData.kal) {
            let springRequestData = {
              date: dietData.date,  // 사용자가 선택한 날짜
              breakfast: dietData.breakfast ? dietData.breakfast : null,  // 아침 식단
              lunch: dietData.lunch ? dietData.lunch : null,  // 점심 식단
              dinner: dietData.dinner ? dietData.dinner : null,  // 저녁 식단
              kal: {
                b: responseData.kal.b || 0,  // 아침 칼로리
                l: responseData.kal.l || 0,  // 점심 칼로리
                d: responseData.kal.d || 0,  // 저녁 칼로리
                t: responseData.kal.t || 0,  // 총 칼로리
                RDI: responseData.kal.RDI || 0.0  // 권장 섭취량
              },
              over: responseData.over || [],  // 과다 섭취된 영양소 리스트
              lack: responseData.lack || [],  // 부족한 영양소 리스트
              rec: responseData.rec || "",  // 영양 추천
              score: responseData.score || 0  // 식단 점수
            };

            // 스프링 서버로 전송
            $.ajax({
              url: '/cal/dietSave',  // 스프링 서버 엔드포인트
              type: 'POST',
              contentType: 'application/json',  // JSON 형식으로 데이터 전송
              data: JSON.stringify(springRequestData),  // 스프링 서버로 보낼 데이터를 직렬화
              success: function() {
                console.log("식단이 스프링 서버에 성공적으로 저장되었습니다.");
                document.getElementById('diet-loading-modal').style.display = 'none';
                document.getElementById('diet-modal').style.display = 'none';

                window.location.href = "/#calendar";  // 달력 페이지로 리다이렉트
              },
              error: function(xhr, status, error) {
                console.log("에러 발생:", xhr.responseText);  // 에러 발생 시 콘솔에 출력
                document.getElementById('diet-loading-modal').style.display = 'none';
              }
            });
          } else {
            // kal 데이터가 없을 경우 경고창 출력
            alert("칼로리 데이터를 가져오지 못했습니다. 다시 시도해 주세요.");
            document.getElementById('diet-loading-modal').style.display = 'none';  // 로딩 모달 숨기기
          }

        },
        error: function() {
          alert('FastAPI 서버에서 데이터를 받는 데 실패했습니다.');
          document.getElementById('diet-loading-modal').style.display = 'none';
        }
      });



      function calculateAge(birthDate) {
        let today = new Date();
        let birthDateObj = new Date(birthDate);
        let age = today.getFullYear() - birthDateObj.getFullYear();
        let monthDiff = today.getMonth() - birthDateObj.getMonth();

        // 생일이 지나지 않았다면 나이를 1살 줄임
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDateObj.getDate())) {
          age--;
        }

        return age;
      }
    }
  </script>

<style>
  /* 로딩 모달 스타일 */
  #diet-loading-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    justify-content: center;
    align-items: center;
    z-index: 1000;
    display: none; /* 기본적으로 숨김 */
  }
  .loading-modal-content {
    background: white;
    padding: 20px;
    border-radius: 8px;
    text-align: center;
    font-size: 2rem;
    font-weight: bold;
    color: #81c405 !important;
    border: 2px solid #FFB524; /* 밝은 주황색 테두리 */

  }
  .spinner {
    width: 17.6px;
    height: 17.6px;
    border-radius: 17.6px;
    box-shadow: 44px 0px 0 0 rgba(255, 181, 36, 0.2),
    35.6px 26px 0 0 rgba(255, 181, 36, 0.4),
    13.64px 41.8px 0 0 rgba(255, 181, 36, 0.6),
    -13.64px 41.8px 0 0 rgba(255, 181, 36, 0.8),
    -35.6px 26px 0 0 #ffb524;
    animation: spinner-b87k6z 1s infinite linear;
    margin: 80px auto; /* 스피너 위치 조정 */
  }

  @keyframes spinner-b87k6z {
    to {
      transform: rotate(360deg);
    }
  }
</style>

  <link rel="stylesheet" href="/css/calendarCSS.css">
</div>  <!--fragment 용-->



