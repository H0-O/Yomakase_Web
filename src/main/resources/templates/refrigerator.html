<div th:fragment="refrigerator" xmlns:th="http://www.thymeleaf.org">
    <link rel="stylesheet" th:href="@{/css/refrigeratorCSS.css}">
    <script th:src="@{/jq/jquery-3.7.1.min.js}"></script>
    <!-- 나의 냉장고 -->
    <section class="resume-section" id="myRefrigerator">
        <div class="resume-section-content" id="myRefrigeratorContent">
            <div class="refrigerator-wrapper">
                <div class="refrigerator-photo">
                    <!-- 레시피 모달창 버튼 -->
                    <button id="RecipeModalBtn" class="refriBtn">요리법 추천</button>
                    <br>
                    <div class="refrigerator-container" id="refrigerator-container">
                        <!-- 냉장고 배경 이미지 추가 -->
                        <div id="ingredients-container">
                            <!-- 식재료 이미지 담을 컨테이너 -->
                        </div>
                    </div>
                </div>
                <br>
                <!-- 데이터 테이블 영역 -->
                <div class="table-container" id="tableContainer" style="display: none;">
                    <div class="table-wrapper">
                        <table id="materialsTable">
                            <thead>
                            <tr>
                                <th>소비기한</th>
                            </tr>
                            </thead>
                            <tbody id="list">
                            <!-- 식재료 테이블 데이터 -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- 데이터가 없을 때 보여줄 페이지 -->
                <div id="noDataMessage" style="display: none;">
                    <p>현재 저장된 재료가 없습니다.</p>
                </div>
                <!-- 식재료 삭제 모달 페이지 -->
                <div id="delModal" class="modal-overlay">
                    <div class="modal-window">
                        <div class="close-area">X</div>
                        <div class="modal-text">
                            <!-- 모달에 식재료 이름 표시 -->
                        </div>
                        <div class="button-container">
                            <button class="refriBtn" id="consume-btn">소비</button>
                            <button class="refriBtn" id="discard-btn">버림</button>
                        </div>
                    </div>
                </div>
                <!-- 날짜 수정 모달 페이지 -->
                <div id="dateModal" class="modal-overlay">
                    <div class="modal-window">
                        <div class="close-area">X</div>
                        <p class="date-text">소비기한 수정</p>
                        <div id="date-container">
                            <input type="hidden" id="ingredientName" value="">
                            <input type="hidden" id="memberNum" value="">
                            <div class="date-input-container">
                                <input type="date" id="date">
                                <button id="submitDate" class="refriBtn">확인</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- 레시피 모달 페이지 -->
                <div id="RecipeModal" class="modal-overlay" style="display: none;">
                    <div class="modal-window">
                            <!-- 추천메뉴 -->
                            <h2><span id="food-name"></span></h2>
                            <img onclick="closeModal()" src="/img/closeIcon.png">
                        <div class="title" style="align-content: center">
                            <button class="btn" onclick="saveRecipe()" style="justify-content: flex-end;">레시피 저장</button>
                        </div>
                        <h3>레시피</h3>
                        <p id="recipe-details"></p> <!-- 레시피 내용 표시 -->

                        <h3>추가 설명</h3>
                        <p id="recipe-comment"></p> <!-- 레시피 설명 -->

                        <h3>관련 동영상</h3>
                        <iframe id="recipe-video" width="560" height="315"
                                title="YouTube video player" frameborder="0"
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                                referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
                    </div>
                </div>
                <script>
                    // 모달 열기 함수
                    function openModal(recipe, video) {
                        // 레시피 데이터 출력
                        document.getElementById('food-name').innerText = recipe.food_name;
                        document.getElementById('recipe-details').innerText = recipe.recipe;
                        document.getElementById('recipe-comment').innerText = recipe.comment;

                        // 유튜브 동영상 링크 출력
                        document.getElementById('recipe-video').src = video.url.replace("watch?v=", "embed/");

                        // 모달을 화면에 보이게 함
                        document.getElementById('RecipeModal').style.display = 'block';
                    }

                    // 모달 닫기 함수
                    function closeModal() {
                        document.getElementById('RecipeModal').style.display = 'none';
                    }

                    // 레시피 저장 버튼 클릭 시 호출될 함수
                    async function saveRecipe() {
                        const memberNum = 1; // 실제 로그인된 사용자의 번호를 사용해야 합니다.
                        const foodName = document.getElementById('food-name').innerText;
                        const recipeDetails = document.getElementById('recipe-details').innerText;
                        const recipeUrl = document.getElementById('recipe-video').src;

                        try {
                            const response = await fetch('/api/recipes/save', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/x-www-form-urlencoded'
                                },
                                body: new URLSearchParams({
                                    memberNum: memberNum,
                                    foodName: foodName,
                                    recipeUrl: recipeUrl,
                                    savedRecipe: recipeDetails
                                })
                            });

                            if (response.ok) {
                                alert('레시피가 저장되었습니다.');
                                closeModal();
                            } else {
                                alert('레시피 저장에 실패했습니다.');
                            }
                        } catch (error) {
                            console.error('Error saving recipe:', error);
                            alert('레시피 저장 중 오류가 발생했습니다.');
                        }
                    }
                </script>
            </div>
        </div>
    </section>
    <script th:inline="javascript">
        var memberAllergies = /*[[${allergy}]]*/ [];
    </script>
    <script>
        // 날짜 수정 ajax
        $(document).ready(function () {
            // 모달 열기
            function dateModalOn(ingredientName, memberNum) {
                // 모달창을 열기 전에 값 설정
                document.getElementById('ingredientName').value = ingredientName;
                document.getElementById('memberNum').value = memberNum;
                $('#dateModal').fadeIn();  // 모달창 열기 (fade 효과)
            }

            // 모달이 열려 있는지 확인
            function isDateModalOn() {
                console.log($("#dateModal").css("display")); // 모달 상태 로그로 확인
                return $("#dateModal").css("display") === "flex";
            }

            // 모달 닫기
            function dateModalOff() {
                $('#dateModal').fadeOut();  // 모달창 닫기 (fade 효과)
            }

            // 테이블에서 수정 버튼을 클릭하면 모달을 띄우고 값 세팅
            $('#list').on('click', '.refriBtn', function () {
                const ingredientName = $(this).data('ingredient-name');
                const memberNum = $(this).data('member-num');

                // 모달 열기 전에 데이터가 제대로 들어갔는지 확인
                console.log('ingredientName:', ingredientName);
                console.log('memberNum:', memberNum);

                // 모달 열기
                dateModalOn(ingredientName, memberNum);
            });

            // X 버튼 클릭 시 모달 닫기
            $('.close-area').click(function () {
                dateModalOff();
            });

            // 모달창 바깥 영역을 클릭하면 모달창이 꺼지게 하기
            $('#dateModal').click(function (e) {
                // 클릭한 대상이 모달 자체인지 확인
                if ($(e.target).is('#dateModal')) {
                    dateModalOff(); // 모달 닫기 함수 호출
                }
            });


            // 확인 버튼 클릭 시 날짜 업데이트
            $('#submitDate').click(function () {
                const dateInput = $('#date').val();  // 날짜 입력 값
                const ingredientName = $('#ingredientName').val();
                const memberNum = $('#memberNum').val();

                if (!dateInput) {
                    alert('날짜를 선택해주세요.');
                    return;
                }

                // 서버로 데이터 전송
                fetch('/rest/stockDate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ingredientName: ingredientName,
                        memberNum: memberNum,
                        useByDate: dateInput
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('날짜가 성공적으로 업데이트되었습니다.');

                            dateModalOff(); // 모달 닫기

                            location.reload(); // 페이지 새로고침
                        } else {
                            alert('업데이트에 실패했습니다.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('서버와의 통신 중 오류가 발생했습니다.');
                    });
            });
        }); // 날짜 수정문 끝

        function calculateDday(dateString) {
            // 현재 날짜
            const today = new Date();
            today.setHours(0, 0, 0, 0); // 오늘 날짜의 시간을 0으로 설정
            // useByDate를 Date 객체로 변환
            const useByDate = new Date(dateString);
            useByDate.setHours(0, 0, 0, 0); // 소비기한 날짜의 시간도 0으로 설정

            // 남은 일수 계산
            const timeDiff = useByDate - today;
            const daysLeft = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));

            // 디데이 형식으로 반환
            if (daysLeft > 0) {
                return `D-${daysLeft}`;
            } else if (daysLeft === 0) {
                return "D-Day";
            } else {
                return `D+${Math.abs(daysLeft)}`;
            }
        }

        function getDdayClass(daysLeft) {
            if (daysLeft === 0) {
                return "d-day-last";
            } else if (daysLeft > 0 && daysLeft <= 1) {
                return "d-day-warning";
            } else if (daysLeft < 0){
                return "d-day-over";
            } else {
                return "d-day";
            }
        }

        $(document).ready(function() {
            $.ajax({
                url : "/rest/stockData",
                type : "POST",
                dataType : "json",
                success : function(list) {
                    console.log(list); // 데이터 형식 확인

                    // 테이블이 담길 변수
                    let txt = ``;

                    // 데이터가 있는지 확인
                    if (list.length > 0) {
                        // 소비기한을 기준으로 오름차순 정렬
                        list.sort(function (a, b) {
                            return new Date(a.useByDate) - new Date(b.useByDate);
                        });

                        // 테이블 시작
                        txt += `<table>`;

                        $(list).each(function (index, object) {
                            const today = new Date();
                            const useByDate = new Date(object.useByDate);
                            const timeDiff = useByDate - today;
                            const daysLeft = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
                            const dDayText = calculateDday(object.useByDate);
                            const dDayClass = getDdayClass(daysLeft);

                            // 테이블 행 추가
                            txt += `
                            <tr>
                                <td>${object.ingredientName}</td>
                                <td class="${dDayClass}">${dDayText}</td>
                                <td><button class="refriBtn" data-ingredient-name="${object.ingredientName}" data-member-num="${object.memberNum}">수정</button></td>
                            </tr>`;
                        });
                        // 테이블 끝
                        txt += `</table>`;
                    } else {
                        // 데이터가 없을 때 표시할 메시지
                        txt = `<p>현재 저장된 재료가 없습니다.</p>`;
                    }
                    // 데이터를 테이블 영역에 삽입
                    $("#list").html(txt);

                    // 데이터가 있을 때는 테이블을 표시하고 없을 때는 메시지 표시
                    if (list.length > 0) {
                        $("#tableContainer").show();  // 테이블 표시
                        $("#noDataMessage").hide();   // 데이터 없을 때 메시지 숨김
                    } else {
                        $("#tableContainer").hide();  // 테이블 숨김
                        $("#noDataMessage").show();   // 데이터 없을 때 메시지 표시
                    }
                },
                error: function(xhr, status, error) {
                    console.error("AJAX 요청 실패:", status, error); // 에러 메시지 확인
                    console.error("응답 내용:", xhr.responseText); // 추가된 부분
                    alert("출력 실패");
                }
            });
        }); // stock 테이블 출력문 끝

        document.addEventListener('DOMContentLoaded', function() {
            fetch('/rest/stockImg')  // 컨트롤러 경로에 맞추어 요청
                .then(response => response.json())
                .then(stockItems => {
                    const container = document.getElementById('ingredients-container');

                    // 테이블의 내용을 초기화
                    const listElement = document.getElementById('list');
                    listElement.innerHTML = ''; // 이전 내용 제거

                    if (stockItems.length === 0) {
                        // 데이터가 없을 경우 메시지 표시
                        const noDataMessage = document.createElement('tr');
                        noDataMessage.innerHTML = '<td colspan="3">등록된 식재료가 없습니다.</td>'; // 모든 열을 차지하도록 설정
                        listElement.appendChild(noDataMessage);
                    } else {
                        // 컨테이너의 크기
                        const containerWidth = container.offsetWidth;
                        const containerHeight = container.offsetHeight;

                        // 그리드의 행과 열 수
                        const rows = 3;
                        const cols = 3;

                        // 각 아이템의 크기 (가로 및 세로)
                        const itemWidth = containerWidth / cols;
                        const itemHeight = containerHeight / rows;

                        // 간격 조정 값 (픽셀 단위)
                        const colGap = -15;  // 간격을 줄이기 위한 값 (조정 가능)
                        const rowGap = -85;

                        stockItems.forEach((item, index) => {
                            const ingredientDiv = document.createElement('div');
                            ingredientDiv.className = 'ingredient';

                            // JSON 데이터의 필드에 맞게 수정
                            const img = document.createElement('img');
                            img.src = `/img/${item.image}`; // 서버에서 반환된 이미지 파일명과 경로 사용
                            img.alt = item.name; // 서버에서 반환된 재료 이름
                            img.className = 'del-modal'; // 클릭 이벤트를 위한 클래스

                            img.addEventListener('click', () => {
                                delModalOn(); // 클릭 시 모달 열기
                            });

                            const text = document.createElement('div');
                            text.className = 'ingredient-text';
                            text.textContent = item.name;  // 재료 이름 텍스트로 사용

                            ingredientDiv.appendChild(img);
                            ingredientDiv.appendChild(text);

                            // 위치를 설정 (3x3 그리드에 맞게 배치)
                            const rowIndex = Math.floor(index / cols);
                            const colIndex = index % cols;

                            // 간격을 고려하여 위치 조정
                            ingredientDiv.style.position = 'absolute'; // absolute 위치 설정 필요
                            ingredientDiv.style.top = `${rowIndex * (itemHeight + rowGap)}px`; // y축 위치
                            ingredientDiv.style.left = `${colIndex * (itemWidth + colGap)}px`; // x축 위치

                            // 삭제 버튼 클릭 이벤트 추가
                            ingredientDiv.addEventListener('click', () => showIngredientName(item.name));

                            container.appendChild(ingredientDiv);
                        });
                    }
                })
                .catch(error => console.error('Error:', error));
        }); // stock 이미지 출력문 끝

        // 재료 삭제 모달
        const delModal = document.getElementById('delModal');
        const modalText = delModal.querySelector('.modal-text');

        function showIngredientName(text) {
            modalText.textContent = text;
            delModalOn();
        }

        function delModalOn() {
            delModal.style.display = 'flex';
        }

        function isDelModalOn() {
            return delModal.style.display === "flex";
        }

        function delModalOff() {
            delModal.style.display = 'none';
        }

        // 모달창의 클로즈(x) 버튼을 누르면 모달창이 꺼지게 하기
        const closeDel = delModal.querySelector(".close-area");
        closeDel.addEventListener("click", () => {
            delModalOff();
        });

        // 모달창 바깥 영역을 클릭하면 모달창이 꺼지게 하기
        delModal.addEventListener("click", (e) => {
            if (e.target.classList.contains("modal-overlay")) {
                delModalOff();
            }
        });

        // 모달창이 켜진 상태에서 ESC 버튼을 누르면 모달창이 꺼지게 하기
        window.addEventListener("keyup", (e) => {
            if (isDelModalOn() && e.key === "Escape") {
                delModalOff();
            }
        }); // 삭제 모달창 끝


        // 레시피 추천 버튼 클릭 시 서버에 요청을 보내고 데이터를 받아 모달에 출력
        document.getElementById('RecipeModalBtn').addEventListener('click', function() {
            const rows = document.querySelectorAll("#materialsTable tbody tr");
            let ingredientNames = [];

            rows.forEach(function(row) {
                const ingredientName = row.querySelector("td:first-child").textContent.trim();
                ingredientNames.push(ingredientName);
            });

            const allergies = Object.entries(memberAllergies.allergies)
                .filter(([key, value]) => value === true)
                .map(([key]) => key);

            const requestData = {
                allergies: allergies,
                ingredients: ingredientNames
            };

            // 서버에 요청을 보내고 데이터를 받아와서 모달에 출력
            fetch('http://localhost:8000/recipe-recommend', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData),
            })
                .then(response => response.json())
                .then(data => {
                    console.log('Received data:', data);
                    // 받은 데이터를 openModal 함수에 전달
                    openModal(data.recipe, data.youtube);
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
        });


        // 레시피 추천 모달
        const RecipeModal = document.getElementById("RecipeModal");

        function RecipeModalOn() {
            RecipeModal.style.display = "flex"; // 모달을 보이게 함
        }

        function isRecipeModalOn() {
            return RecipeModal.style.display === "flex"; // 모달이 열려 있는지 확인
        }

        function RecipeModalOff() {
            RecipeModal.style.display = "none"; // 모달을 숨김
        }

        const RecipeModalBtn = document.getElementById("RecipeModalBtn");

        // 특정 버튼을 누르면 모달창이 켜지게 하기
        RecipeModalBtn.addEventListener("click", () => {
            RecipeModalOn();
        });

        // 모달창의 클로즈(x) 버튼을 누르면 모달창이 꺼지게 하기
        const closeBtn = RecipeModal.querySelector(".close-area");
        closeBtn.addEventListener("click", () => {
            RecipeModalOff();
        });

        // 모달창 바깥 영역을 클릭하면 모달창이 꺼지게 하기
        RecipeModal.addEventListener("click", (e) => {
            if (e.target === RecipeModal) {
                RecipeModalOff();
            }
        });
    </script>
</div>