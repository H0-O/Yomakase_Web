<div th:fragment="profileUpdateFragment">

    <!-- 통합된 폼 -->
    <div id="signup-form">
        <!-- 첫 번째 화면 -->
        <div class="first-container">
            <div class="form-group">
                <label for="email">이메일(수정불가)</label>
                <!-- 사용자의 이메일을 표시하는 필드 (수정 불가) -->
                <input type="text" id="email" name="email" th:value="${member.email}" readonly>
            </div>
            <div class="form-group">
                <label for="nickname">닉네임(수정불가)</label>
                <!-- 사용자의 닉네임을 표시하는 필드 (수정 불가) -->
                <input type="text" id="nickname" name="nickname" th:value="${member.nickname}" readonly>
            </div>
            <div class="form-group">
                <label for="password">비밀번호</label>
                <!-- 사용자 비밀번호 입력 필드 -->
                <input type="password" id="password" name="password" placeholder="새 비밀번호를 입력하세요">
            </div>
            <div class="form-group">
                <label for="confirmPassword">비밀번호 확인</label>
                <!-- 비밀번호 확인 입력 필드 -->
                <input type="password" id="confirmPassword" name="confirmPassword" placeholder="비밀번호를 다시 입력하세요">
            </div>
            <div class="form-group">
                <label for="birthdate">생년월일</label>
                <!-- 사용자의 생년월일을 표시하고 수정할 수 있는 필드 -->
                <input type="date" id="birthdate" name="birthdate" th:value="${member.birthdate}">
            </div>
            <label for="gender">성별</label>
            <div class="gender-toggle">
                <!-- 성별 버튼: 남성 선택 시 'selected' 클래스가 추가 -->
                <button type="button" id="male-btn" class="selected" th:classappend="${member.gender == 'M'} ? 'selected' : ''">남성</button>
                <!-- 성별 버튼: 여성 선택 시 'selected' 클래스가 추가 -->
                <button type="button" id="female-btn" th:classappend="${member.gender == 'F'} ? 'selected' : ''">여성</button>
            </div>
            <!-- 성별 정보를 hidden 필드에 저장하여 제출할 때 사용 -->
            <input type="hidden" id="gender" name="gender" th:value="${member.gender}">
            <!-- 다음 버튼을 클릭하면 두 번째 화면으로 넘어감 -->
            <button type="button" id="next-btn" class="btn">다음</button>
        </div>

        <!-- 두 번째 화면 -->
        <div class="second-container" style="display:none;">
            <div class="form-group">
                <label for="height">키</label>
                <!-- 사용자의 키 정보를 입력하는 필드 -->
                <input type="number" id="height" name="height" th:value="${member.height}">
            </div>
            <div class="form-group">
                <label for="weight">몸무게</label>
                <!-- 사용자의 몸무게 정보를 입력하는 필드 -->
                <input type="number" id="weight" name="weight" th:value="${member.weight}">
            </div>
            <div class="form-group">
                <label>알레르기 정보</label>
                <div class="allergy-group">
                    <!-- 알레르기 정보 드롭다운: 고기류 -->
                    <div class="dropdown">
                        <div class="dropdown-label" id="meat-dropdown">
                            고기류
                            <span>&#9662;</span>
                        </div>
                        <div class="dropdown-content" id="meat-content">
                            <!-- 알레르기 정보: 돼지고기 -->
                            <label data-allergy="pork">돼지고기</label>
                            <!-- 알레르기 정보: 닭고기 -->
                            <label data-allergy="chicken">닭고기</label>
                            <!-- 알레르기 정보: 쇠고기 -->
                            <label data-allergy="beef">쇠고기</label>
                        </div>
                    </div>
                    <!-- 알레르기 정보 드롭다운: 해산물 -->
                    <div class="dropdown">
                        <div class="dropdown-label" id="seafood-dropdown">
                            해산물
                            <span>&#9662;</span>
                        </div>
                        <div class="dropdown-content" id="seafood-content">
                            <!-- 알레르기 정보: 고등어 -->
                            <label data-allergy="mackerel">고등어</label>
                            <!-- 알레르기 정보: 새우 -->
                            <label data-allergy="shrimp">새우</label>
                            <!-- 알레르기 정보: 오징어 -->
                            <label data-allergy="squid">오징어</label>
                        </div>
                    </div>
                    <!-- 알레르기 정보 드롭다운: 견과류 -->
                    <div class="dropdown">
                        <div class="dropdown-label" id="nut-dropdown">
                            견과류
                            <span>&#9662;</span>
                        </div>
                        <div class="dropdown-content" id="nut-content">
                            <!-- 알레르기 정보: 땅콩 -->
                            <label data-allergy="peanut">땅콩</label>
                            <!-- 알레르기 정보: 호두 -->
                            <label data-allergy="walnut">호두</label>
                            <!-- 알레르기 정보: 잣 -->
                            <label data-allergy="pineNut">잣</label>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 각 알레르기 항목의 값을 hidden 필드로 관리 -->
            <input type="hidden" id="eggs" name="eggs" th:value="${member.isEggs()}">
            <input type="hidden" id="milk" name="milk" th:value="${member.isMilk()}">
            <input type="hidden" id="buckwheat" name="buckwheat" th:value="${member.isBuckwheat()}">
            <input type="hidden" id="peanut" name="peanut" th:value="${member.isPeanut()}">
            <input type="hidden" id="soybean" name="soybean" th:value="${member.isSoybean()}">
            <input type="hidden" id="wheat" name="wheat" th:value="${member.isWheat()}">
            <input type="hidden" id="mackerel" name="mackerel" th:value="${member.isMackerel()}">
            <input type="hidden" id="crab" name="crab" th:value="${member.isCrab()}">
            <input type="hidden" id="shrimp" name="shrimp" th:value="${member.isShrimp()}">
            <input type="hidden" id="pork" name="pork" th:value="${member.isPork()}">
            <input type="hidden" id="peach" name="peach" th:value="${member.isPeach()}">
            <input type="hidden" id="tomato" name="tomato" th:value="${member.isTomato()}">
            <input type="hidden" id="walnuts" name="walnuts" th:value="${member.isWalnuts()}">
            <input type="hidden" id="chicken" name="chicken" th:value="${member.isChicken()}">
            <input type="hidden" id="beef" name="beef" th:value="${member.isBeef()}">
            <input type="hidden" id="squid" name="squid" th:value="${member.isSquid()}">
            <input type="hidden" id="shellfish" name="shellfish" th:value="${member.isShellfish()}">
            <input type="hidden" id="pineNut" name="pineNut" th:value="${member.isPineNut()}">
            <!-- 이전 버튼 -->
            <button type="button" id="back-btn" class="btn">이전</button>
            <!-- 제출 버튼 -->
            <button type="submit" class="btn">제출</button>
            <style>
                /* 모달 창 스타일 */
                #signup-form {
                    background-color: white;
                    margin: 5% auto;
                    padding: 20px;
                    width: 80%;
                    height: 80%;
                    max-width: 500px;
                    max-height: 400px;
                    text-align: center;
                    border-radius: 10px;
                    position: relative;
                }

                /* first-container와 second-container에 공통 적용 */
                .first-container, .second-container {
                    position: absolute;
                    padding: 20px;
                    top: 0;
                    left: 0;
                    width: 80%;
                    height: 80%;
                    max-width: 500px;
                    max-height: 400px;
                    transition: opacity 0.5s, transform 0.5s;
                }

                /* first-container의 기본 스타일 */
                .first-container {
                    z-index: 2;
                    opacity: 1;
                    transform: translateX(0);
                    visibility: visible;
                    pointer-events: auto;
                }

                /* 숨겨진 상태일 때 */
                .first-container.hidden {
                    opacity: 0;
                    transform: translateX(-100%);
                    z-index: 1;
                    visibility: hidden;
                    pointer-events: none;
                }

                /* second-container의 기본 스타일 */
                .second-container {
                    opacity: 0;
                    transform: translateX(100%);
                    z-index: 1;
                    visibility: hidden;
                    pointer-events: none;
                }

                /* 활성화된 상태일 때 */
                .second-container.active {
                    opacity: 1;
                    transform: translateX(0);
                    z-index: 2;
                    visibility: visible;
                    pointer-events: auto;
                }

                /* 버튼 스타일 */
                .btn {
                    padding: 5px 10px;
                    margin: 5px;
                    background-color: #81c405;
                    color: white;
                    border: none;
                    border-radius: 1px;
                    cursor: pointer;
                }

                .btn:hover {
                    background-color: #555;
                }

                .form-group {
                    margin-bottom: 10px;
                    text-align: left;
                }

                .form-group label {
                    display: block;
                    margin-bottom: 1px;
                    font-weight: bold;
                    color: #333;
                }

                .form-group input {
                    width: 100%;
                    padding: 10px;
                    border: 1px solid #ddd;
                    border-radius: 5px;
                    font-size: 1rem;
                    box-sizing: border-box;
                }

                .allergy-group {
                    max-height: 250px;
                    overflow-y: auto;
                    margin-bottom: 15px;
                    padding: 10px;
                    border: 1px solid #ddd;
                    border-radius: 5px;
                }

                .dropdown {
                    position: relative;
                    text-align: left;
                    margin-bottom: 10px;
                }

                .dropdown-label {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    cursor: pointer;
                    padding: 10px;
                    background-color: #f1f1f1;
                    border: 1px solid #ddd;
                    border-radius: 5px;
                    font-weight: bold;
                    color: #333;
                    transition: background-color 0.3s;
                }

                .dropdown-label:hover {
                    background-color: #ddd;
                }

                .dropdown-content {
                    display: none;
                    position: relative;
                    width: 100%;
                    background-color: white;
                    border: 1px solid #ddd;
                    border-radius: 5px;
                    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                    margin-top: 5px;
                    overflow: hidden;
                }

                .dropdown-content.show {
                    display: block;
                }

                .dropdown-content label {
                    display: block;
                    padding: 10px;
                    border-bottom: 1px solid #ddd;
                    cursor: pointer;
                }

                .dropdown-content label:last-child {
                    border-bottom: none;
                }

                .dropdown-content label.selected {
                    background-color: #81c405;
                    color: white;
                }

                .gender-toggle button {
                    padding: 10px 20px;
                    margin: 5px;
                    background-color: #f1f1f1;
                    color: #333;
                    border: 1px solid #ddd;
                    border-radius: 5px;
                    cursor: pointer;
                }

                .gender-toggle button.selected {
                    background-color: #81c405;
                    color: white;
                }

                .gender-toggle button:hover {
                    background-color: #ddd;
                }
            </style>
            <script>
                // DOM이 완전히 로드된 후에 이벤트 리스너를 등록하기 위해 'DOMContentLoaded' 이벤트 사용
                document.addEventListener('DOMContentLoaded', function() {
                    // 각 버튼 요소를 변수에 저장
                    const maleBtn = document.getElementById('male-btn');   // 남성 버튼
                    const femaleBtn = document.getElementById('female-btn'); // 여성 버튼
                    const nextBtn = document.getElementById('next-btn');   // 다음 버튼
                    const backBtn = document.getElementById('back-btn');   // 이전 버튼
                    const submitBtn = document.getElementById('submit-btn'); // 제출 버튼

                    // 남성 버튼이 존재하는 경우에만 클릭 이벤트 리스너 등록
                    if (maleBtn) {
                        maleBtn.addEventListener('click', function() {
                            document.getElementById('gender').value = 'M';  // 남성 선택 시 성별 hidden 필드 값 'M'으로 설정
                            this.classList.add('selected');  // 남성 버튼에 'selected' 클래스 추가 (선택 시 스타일 변경)
                            document.getElementById('female-btn').classList.remove('selected');  // 여성 버튼에서 'selected' 클래스 제거
                        });
                    }

                    // 여성 버튼이 존재하는 경우에만 클릭 이벤트 리스너 등록
                    if (femaleBtn) {
                        femaleBtn.addEventListener('click', function() {
                            document.getElementById('gender').value = 'F';  // 여성 선택 시 성별 hidden 필드 값 'F'로 설정
                            this.classList.add('selected');  // 여성 버튼에 'selected' 클래스 추가 (선택 시 스타일 변경)
                            document.getElementById('male-btn').classList.remove('selected');  // 남성 버튼에서 'selected' 클래스 제거
                        });
                    }

                    // '다음' 버튼 클릭 시 실행되는 이벤트 리스너
                    if (nextBtn) {
                        nextBtn.addEventListener('click', function() {
                            const password = document.getElementById('password').value;  // 비밀번호 필드 값 가져오기
                            const confirmPassword = document.getElementById('confirmPassword').value;  // 비밀번호 확인 필드 값 가져오기

                            // 비밀번호와 비밀번호 확인 값이 일치하지 않으면 경고창 표시
                            if (password !== confirmPassword) {
                                alert('비밀번호가 일치하지 않습니다.');
                                return;  // 비밀번호가 일치하지 않으면 더 이상 진행하지 않음
                            }
                            // 첫 번째 화면을 숨기고 두 번째 화면을 표시
                            document.querySelector('.first-container').style.display = 'none';
                            document.querySelector('.second-container').style.display = 'block';
                        });
                    }

                    // '이전' 버튼 클릭 시 실행되는 이벤트 리스너
                    if (backBtn) {
                        backBtn.addEventListener('click', function() {
                            // 첫 번째 화면을 다시 표시하고 두 번째 화면을 숨김
                            document.querySelector('.first-container').style.display = 'block';
                            document.querySelector('.second-container').style.display = 'none';
                        });
                    }

                    // 드롭다운 라벨 클릭 시 드롭다운 내용을 열고 닫는 이벤트 리스너
                    document.querySelectorAll('.dropdown-label').forEach(function(label) {
                        label.addEventListener('click', function() {
                            const content = this.nextElementSibling;  // 라벨의 다음 요소(드롭다운 내용)를 선택
                            // 드롭다운 내용의 표시 상태를 토글 (열기/닫기)
                            content.style.display = (content.style.display === 'block') ? 'none' : 'block';
                        });
                    });

                    // 드롭다운 항목 클릭 시 알레르기 값을 설정하는 이벤트 리스너
                    document.querySelectorAll('.dropdown-content label').forEach(function(label) {
                        label.addEventListener('click', function() {
                            const allergy = this.getAttribute('data-allergy');  // 클릭된 항목의 알레르기 종류 가져오기
                            const input = document.getElementById(allergy);  // 해당 알레르기와 연결된 hidden 필드 선택

                            // 이미 선택된 항목인 경우 선택 해제
                            if (input.value === 'true') {
                                input.value = 'false';  // hidden 필드 값을 'false'로 설정
                                this.classList.remove('selected');  // 선택 해제 시 스타일 제거
                            } else {
                                // 선택되지 않은 항목인 경우 선택
                                input.value = 'true';  // hidden 필드 값을 'true'로 설정
                                this.classList.add('selected');  // 선택 시 스타일 추가
                            }
                        });
                    });

                    // '제출' 버튼 클릭 시 실행되는 이벤트 리스너
                    if (submitBtn) {
                        submitBtn.addEventListener('click', function(event) {
                            event.preventDefault();  // 기본 폼 제출 동작 중단

                            // 입력된 폼 데이터를 변수에 저장
                            const email = document.getElementById('email').value;
                            const nickname = document.getElementById('nickname').value;
                            const password = document.getElementById('password').value;
                            const birthdate = document.getElementById('birthdate').value;
                            const gender = document.getElementById('gender').value;
                            const height = document.getElementById('height').value;
                            const weight = document.getElementById('weight').value;

                            // 알레르기 정보 수집 (선택된 항목만 수집)
                            const allergies = [];
                            document.querySelectorAll('input[type="hidden"]').forEach(function (checkbox) {
                                if (checkbox.value === 'true') {
                                    allergies.push(checkbox.getAttribute('id'));  // 선택된 알레르기 항목을 배열에 추가
                                }
                            });

                            // 서버로 보낼 데이터 객체 생성
                            const data = {
                                id: email,
                                nickname: nickname,
                                birthdate: birthdate,
                                password: password,
                                gender: gender,
                                height: height,
                                weight: weight,
                                allergies: allergies
                            };

                            // 서버로 데이터를 전송하는 AJAX 요청
                            fetch('/member/update', {
                                method: 'POST',  // HTTP 메소드 POST 사용
                                headers: {
                                    'Content-Type': 'application/json',  // JSON 형식으로 전송
                                },
                                body: JSON.stringify(data)  // 데이터를 JSON 문자열로 변환하여 전송
                            })
                                .then(response => {
                                    if (response.ok) {
                                        return response.json();  // 응답이 성공적이면 JSON으로 변환
                                    } else {
                                        throw new Error('서버에서 오류가 발생했습니다.');  // 오류 발생 시 에러 처리
                                    }
                                })
                                .then(result => {
                                    // 서버에서 반환한 데이터를 로그로 출력
                                    console.log("서버 응답 데이터:", result);
                                    alert('회원 정보가 성공적으로 업데이트되었습니다.');  // 성공 메시지 표시
                                    window.location.href = '/';  // 업데이트 후 페이지 리다이렉트
                                })
                                .catch(error => {
                                    // 오류 발생 시 오류 로그 출력
                                    console.error('오류 발생:', error);
                                });
                        });
                    }
                });
            </script>
        </div>
    </div>
</div>
