<div th:fragment="subsFragment">
    <link rel="stylesheet" th:href="@{/css/subsCSS.css}">
    <div class="subscription">
        <p>구독 시 제공할 서비스</p>
        <ul>
            <li>광고 제거 기능</li>
            <li>식단 점수 달력 제공</li>
        </ul>
        <p><strong>※ 구독 시 유의사항</strong></p>
        <p>월 490원으로 제공되는 구독 서비스입니다. 결제는 매월 자동으로 이루어지며, 언제든지 구독을 취소할 수 있습니다。</p>
        <p>구독 서비스는 「전자상거래 등에서의 소비자 보호에 관한 법률」에 따라 보호받습니다。</p>
        <div>
            <input type="checkbox" id="mypagesAgreeTerms" name="mypagesAgreeTerms" />
            <label for="mypagesAgreeTerms">결제에 동의함</label>
        </div>
    </div>
    <!-- 처음에 버튼을 숨기기 위해 display: none을 적용 -->
    <div id="subBtn-container">
        <button id="mypagesSubscribeButton" onclick="subscribe()" style="display: none;">결제</button>
    </div>
    <script>
        // 체크박스 상태 변경 시 버튼 활성화/비활성화 처리
        document.getElementById('mypagesAgreeTerms').addEventListener('change', function() {
            const isChecked = this.checked;
            console.log('Checkbox changed:', isChecked);
            const subscribeButton = document.getElementById('mypagesSubscribeButton');

            if (isChecked) {
                subscribeButton.style.display = 'flex'; // 체크박스가 선택되면 버튼을 표시
            } else {
                subscribeButton.style.display = 'none'; // 체크박스가 선택되지 않으면 버튼을 숨김
            }
        });

        // 구독 버튼 클릭 시 구독 처리
        function subscribe() {
            console.log('Subscribe button clicked');
            const isAgreed = document.getElementById('mypagesAgreeTerms').checked;

            if (isAgreed) {
                console.log('Agreement checked');

                // fetch API를 사용한 POST 요청
                fetch('/subscribe', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({}), // 서버로 전송할 데이터 (필요에 따라 수정)
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Success:', data);
                        alert('결제창으로 넘어갑니다...')
                        alert('구독 완료');
                        // 구독 성공 후 페이지 새로고침
                        window.location.reload(); // 페이지를 새로고침하여 구독 상태 반영
                    })
                    .catch((error) => {
                        console.error('Error:', error);
                        alert('구독에 실패했습니다。');
                    });
            } else {
                alert('결제 동의가 필요합니다。');
            }
        }
    </script>
</div>

